/*!
* Data Aquarium Framework - Data Editor for Touch UI
* Copyright 2018-2019 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function s(n,t){var r=n.closest(".dv-item"),i;return t=="above"?r.prev(".dv-item").length>0:(i=r.next(".dv-item"),i.length>0&&!i.find(".ui-btn").is(".app-calculated,.dv-action-see-all"))}function d(){return t.settings("ui.inlineEditing.position")=="top"||t.pointer("touch")}function v(t,i){var r=t.session("targetDataView"),u,f;r&&(u=r.elem,f=u.closest(".dv-item").find(".app-row-status").removeClass("app-row-status-pending app-row-status-error"),i&&f.addClass("app-row-status-"+i),n.sync({dataView:r.id,elem:u,force:!0,scrollIntoView:!0}))}function u(n,i){t.lastTouch(!1);(!n.is(".app-selected")||i)&&n.trigger($.Event("vclick",{ctrlKey:!0}));t.lastTouch(!0)}function y(n){return n.keyCode||n.which}function h(n){var t;return n.length&&(t=n.attr("class").match(/\bapp-field-(\S+)\b/),t&&(t=t[1])),t}function g(n){var t=[];return n._fields.forEach(function(n){var i=n.Name;n.Type=="DataView"||n.isReadOnly()||t.push(i)}),t}function c(n,i){t.scrollGrid(n,i)}function nt(i,r){var y=r.closest(".app-grid");if(y.length){var o=i.session("grid-avail-width"),e=r.closest(".dv-item"),p=Math.ceil(o-o*(e[0].getBoundingClientRect().width/o)),u=i.session("scroll-left")||0,w=u,a=e.find(".app-frozen").last(),f=n.frame()[0].getBoundingClientRect(),v=f.right,s=e[0].getBoundingClientRect(),h=s.right,l=a.length?a[0].getBoundingClientRect():e.find(".app-frozen-spacer")[0].getBoundingClientRect();if(t.pointer("mouse")&&(h-=6),v>h?u=Math.min(v-h+u+16,p):l&&l.right>f.left?r.is(".app-frozen")||(u=Math.max(u-(l.right-f.left)-16,0)):s.left>f.left&&(u=Math.max(u-(s.left-f.left)-16,0)),w!=u)return c(i,u),!0}}function b(n){var r=n.isReadOnly();return r&&(i._buffer=null,t.notify({text:String.format(a.ReadOnly,n.HeaderText),force:!0}),i.focus({lastFocused:!0})),r}var o=$app,t=o.touch,i=o.input,l=$.mobile,n,r=t.fnVisible,p=Web.DataViewResources,a=p.Mobile,k=p.ModalPopup,w,f=o.findDataView,e=t.scrollable;o.prototype.inlineEditing=function(n,i){var r=this,u;if(r._inlineEditingChecked||(r._inlineEditingChecked=!0,r.tagged("inline-editing-option-none")?(r.tagged("inline-editing")||r.tagged("inline-editing-when-pointer")&&!t.pointer("touch"))&&r.tag("inline-editing-mode"):(u=r.pageProp("inlineEditing"),u!=null?r.inlineEditing(u):r.tagged("inline-editing")&&!r._lookupInfo&&r.tag("inline-editing-mode"))),arguments.length)n?r.tag("inline-editing-mode"):r.untag("inline-editing-mode"),i!=!1&&r.pageProp("inlineEditing",n);else return!!r.tagged("inline-editing-mode")};n=t.edit={instance:function(){var n=t.dataView();return n&&n._inlineEditor?n:null},frame:function(t){var i=n._frame;return(t==!1&&(i&&i.remove(),n._frame=null),t==":visible")?i&&i[0].style.visibility!="hidden"&&i.parent().length>0:t==":active"?i&&i[0].style.visibility!="hidden"&&i.closest(".ui-page-active").length>0:(t=="show"?i&&(i[0].style.visibility="",n.sync({scrollIntoView:!1})):t=="hide"?i&&(i[0].style.visibility="hidden"):i||(i=n._frame=$('<span class="app-focus-frame">')),i)},field:function(t){return arguments.length?n._fieldName==t:n._fieldName},dataView:function(){var t;return n.frame(":visible")&&(t=f(n._dataViewId)),t},fieldElem:function(i){arguments.length||(i=n.dataView());var o,s,u,f;return i&&(s=i.session("dataEditor").fieldName,u=t.pageInfo(),f=">",u&&u.id==i._id||(f='.app-echo[data-for="'+i._id+'"]'),o=e().find(f+" .app-listview .app-selected .app-field-"+s).filter(r)),o},dataItem:function(t){var i=t||n.fieldElem();return i?i.closest(".dv-item"):null},detach:function(t){if(!n._moving&&(!arguments.length||t==!0||n._dataViewId==t)&&!n._active){var i=n._frame;i&&(i.css("visibility","hidden"),t==!0&&(i.closest(".ui-page").find(".app-field-is-selected").removeClass("app-field-is-selected app-field-is-selected2"),i.remove()))}},sync:function(u){var k,st=n._pending,ft,ht,a,p,w;if(!k&&u&&u.reset&&st&&(ft=st.editor,ht=f(ft),$("#"+ft).removeClass("app-page-inlineeditor-inactive"),n._pending=null,v(ht,"error"),i.focus({lastFocused:!0}),k=!0),n._pending&&(k=!0),!k){u||(u={});var d=u.elem,s=d,c,g=u.dataView||n._dataViewId,o=g?typeof g=="string"?f(g):g:t.toDataView(s),ct,e=u.fieldName;if(o&&o.inlineEditing())if(o.get_isForm()&&!n.instance())n.detach();else{if(t.isInTransition()){n._lastSyncOptions=u;return}if(ct=o.session("dataEditor")||{},s&&s.is(".app-field")?(e||(e=h(s)),w=s=s.closest(".app-listview")):(c=t.scrollable(s),w=t.dataView()==o?s=c.find(".app-listview"):s=c.find('.app-echo[data-for="'+o._id+'"]').find(".app-listview"),w=w.first()),e||(e=ct.fieldName),!e&&o._allFields&&(e=o._allFields[o._fields[0].AliasIndex].Name),e&&(a=d&&d.is(".app-field-"+e)?d:s.find(".dv-item .ui-btn.app-selected .app-field"+(e?"-"+e:"")).filter(r).first(),a.length||(e=o._allFields[o._fields[0].AliasIndex].Name,a=s.find(".dv-item .ui-btn.app-selected .app-field"+(e?"-"+e:"")).filter(r).first()),a.length&&(s.closest(".ui-page-active").length||u.force)&&(c||(c=t.scrollable(a)),e||(e=h(a)),e))){o.session("dataEditor",{fieldName:e});p=a.find(".app-field-data").last();p.length||(p=a);var tt=p[0].getBoundingClientRect(),lt=c[0].getBoundingClientRect(),l,et,it=n.frame(),ot=n._dataViewId;if(ot!=o._id&&(n._dataViewId=o._id,ot&&t.summary(ot).find(".app-field-is-selected").removeClass("app-field-is-selected app-field-is-selected2")),it.parent().is(c)||it.appendTo(c),u.force!=!0&&u.ignoreOtherInputs!=!0&&$(document.activeElement).closest("[data-input]").length)return;if(it.css("visibility",""),it.css({zIndex:p.css("z-index"),left:tt.left-lt.left-1,top:Math.round(tt.top-lt.top+c.scrollTop()),width:tt.width+2,height:Math.round(tt.height)}),u.scrollIntoView&&nt(o,a)){u.scrollIntoView=!1;n.sync(u);return}if(w.is(".app-grid")){et=p.closest(".dv-item");l=!et.prev().is(".dv-item");var at=w.find(".app-grid-header"),vt=t.dataView()==o?c.closest(".ui-page").find(".dv-heading .app-grid-header"):$(),yt=t.stickyHeaderBar(c),b=at.find(".app-field-is-selected"),y=vt.find(".app-field-is-selected"),rt=yt.find(".app-field-is-selected"),ut;(!b.length&&!y.length||b.length&&(b.attr("data-field-name")!=e||l&&b.is(".app-field-is-selected2")||!l&&!b.is(".app-field-is-selected2"))||y.length&&(y.attr("data-field-name")!=e||l&&y.is(".app-field-is-selected2")||!l&&!y.is(".app-field-is-selected2"))||rt.length&&(rt.attr("data-field-name")!=e||l&&y.is(".app-field-is-selected2")||!l&&!rt.is(".app-field-is-selected2")))&&(b.removeClass("app-field-is-selected app-field-is-selected2"),y.removeClass("app-field-is-selected app-field-is-selected2"),rt.removeClass("app-field-is-selected app-field-is-selected2"),ut='[data-field-name="'+e+'"]',at.find(ut).addClass("app-field-is-selected").toggleClass("app-field-is-selected2",!l),vt.find(ut).addClass("app-field-is-selected").toggleClass("app-field-is-selected2",!l),yt.find(ut).addClass("app-field-is-selected").toggleClass("app-field-is-selected2",!l))}u.scrollIntoView!=!1&&t.makeVisible(n.frame(),c,et)}}}},scrollIntoView:function(i){t.makeVisible(n.dataItem(i))},showField:function(u,s,h){var v,y;if(o.touch.edit.sync({reset:!0}),s!=n._fieldName){var c=u.session("targetDataView"),l=c.elem,a=f(c.id);n._fieldName=s;i.evaluate({dataView:u,row:u.editRow(),fields:[],container:h||e().find('[data-input-container="'+u._id+'"]'),resize:!0});v=n._fieldName;y=c.elem;l=l.closest(".dv-item").find(".app-field-"+a._allFields[a.findField(s).AliasIndex].Name).filter(r);c.elem=l;n.sync({dataView:c.id,elem:l,scrollIntoView:!0,force:!0});t.resetPageHeight()}},toSyncKey:function(t){var i=n._pending;return i&&i.dataViewId==t._id&&i.syncKey?i.syncKey:t._syncKey},moveInput:function(u){var p=t.dataView(),vt=p._inlineFields,v=p._availableFields,yt,y=n.field(),ct,o,lt,rt,e=u.direction||"enter",tt,ut,g,at,a,ft,et,ot,it,st,ht;if($(document.activeElement).blur(),i.valid()){var d=p.session("targetDataView"),k=d.elem,w=f(d.id),nt=k.closest(".dv-item-new").length>0;if(v||(v=p._availableFields=[],yt=[],k.closest(".dv-item").find(".app-field").filter(r).each(function(){var t=this,n=t.className.match(/\bapp\-field\-(.+?)\b/);n&&(n=n[1],n=w.findFieldUnderAlias(n),n&&(n=n.Name,vt.indexOf(n)!=-1&&v.push(n)))})),o=v.indexOf(y),e=="right"?(o++,o>v.length-1&&(o=s(k,"below")||nt?0:v.length-1,!nt,e="down")):e=="left"?(o--,o<0&&(o=s(k,"above")?v.length-1:0,e="up")):typeof e!="string"&&(o=-1,tt=e.closest(".app-field"),ut=h(tt),ut&&(g=w.findFieldUnderAlias(ut),g&&(o=v.indexOf(g.Name),a=d.elem.closest(".dv-item"),at=tt.closest(".dv-item"),a.is(at)?b(g)?o=-1:e="field":(e=tt,ct=g.Name)))),y=v[o]||ct,y)if(e=="right"||e=="left"||e=="field")n.showField(p,y),i.focus({fieldName:y});else{if(e=="down"||e=="up")if(a=k.closest(".dv-item"),a=e=="down"?a.next():a.prev(),a=a.find(".ui-btn"),nt||a.is(".app-calculated")||!a.is(":visible"))if(nt){if(et=k.closest(".dv-item").prev().find(".ui-btn"),ot=et.length?et.data("data-context"):null,o!=0&&(y=v[0],c(w,0),n.showField(p,y)),ot)for(e=ot.row,rt=[],st=w._keyFields,it=0;it<st.length;it++)rt.push(e[st[it].Index]);e="new"}else e="enter";else ft=a.find(".app-field-"+y),ft.length&&(e=ft);l.activePage.addClass("app-page-inlineeditor-inactive");typeof e=="string"||Array.isArray(e)||(n.sync({dataView:w,elem:e,force:!0,scrollIntoView:!0}),e=e.closest(".ui-btn").data("dataContext"),e&&(e=e.row));ht=n._pending={editor:p._id,pageId:n.frame().closest(".ui-page").attr("id"),dataViewId:d.id,action:p.changed()?"post":"cancel",field:w._allFields[w.findField(y).AliasIndex].Name,originalField:y,direction:e,syncKey:rt};lt=d.elem.closest(".dv-item").find(".app-row-status");ht.action=="cancel"?(ht.syncKey=null,t.goBack()):(lt.addClass("app-row-status-pending"),t.executeInContext())}}u.preventDefault()},syncKey:function(t){var i=n._pending;return i&&t._id==i.dataViewId?i.syncKey:null},_broadcastValues:function(t,i){var e=t.session("targetDataView"),o=e.elem,u=o.closest(".dv-item"),s=u.closest(".app-grid").length>0;i.forEach(function(n){var i=t.findField(n.name||n.Name),f=n.name?"newValue"in n?n.newValue:n.value:"NewValue"in n?n.NewValue:n.Value,e;i&&u.find(".app-field-"+i.Name).filter(r).each(function(){var t=$(this),n,u=t.data("inline-undo"),r;u==null&&t.data("inline-undo",{html:t.html(),isNull:t.closest(".app-null").length>0});e=i.text(f);n=t.find(".app-field-data");n.length||(n=t);n.toggleClass("app-null",f==null);r=n.find(".material-icon-check-box,.material-icon-check-box-outline-blank");r.length&&!f?r.text("check_box_outline_blank").addClass("material-icon-check-box-outline-blank").removeClass("material-icon-check-box"):r.length&&f?r.text("check_box").addClass("material-icon-check-box").removeClass("material-icon-check-box-outline-blank"):i.htmlEncode()?n.text(e):n.html(e)})});n.sync({dataView:f(e.id),elem:o,force:!0,scrollIntoView:!0});u.find(".app-row-status:not(.app-row-status-new)").addClass("app-row-status-edit")},undo:function(i){i||(i=t.dataView());var r=i.session("targetDataView"),u=r.elem.closest(".dv-item");u.find(".app-field").each(function(){var n=$(this),t=n.data("inline-undo");t!=null&&(n.removeData("inline-undo"),n.html(t.html),n.find(".app-field-data").length||n.toggleClass("app-null",t.isNull))});u.find(".app-row-status").removeClass("app-row-status-edit");n.sync({dataView:n._dataViewId,elem:r.elem,force:!0})},commit:function(i){function y(){var v=r==="down",c=!r||r==="enter",y=r==="new",i=f(o.dataViewId),p,l,w,e;s==="post"&&i._busy()||(n._pending=null,r==="new"&&(r=new Array(i._allFields.length)),r==="up"||v||c?(n.sync({dataView:i,fieldName:h,scrollIntoView:!0}),c||a.trigger($.Event("keydown",{keyCode:v?40:38})),(n._fieldName!==o.originalField||c)&&n.sync({dataView:i,fieldName:h,scrollIntoView:!0})):r&&Array.isArray(r)&&(i.session("dataEditor").fieldName=h,p=n.fieldElem(i),l=$(p).closest(".app-listview"),l.find(".dv-item .ui-btn").each(function(){var n=$(this),l=n.data("data-context"),e,s,f,h,c,a;if(l&&(e=l.row,e)){for(s=!0,h=i._keyFields,f=0;f<h.length;f++)if(c=h[f].Index,r[c]!=e[c]){s=!1;break}if(s)return o.syncKey&&!y?(n.addClass("app-selected"),u(n,!0),a=n.parent().nextAll(".dv-item-new"),u(a.find(".ui-btn"),!0),t.stickyHeaderBar().hide(),t.stickyHeader()):u(n.removeClass("app-selected")),w=!0,!1}}),!w&&y&&(e=t.summary(l),e.length&&(t.lastTouch(!1),e.find(".dv-action-see-all .app-btn-next").trigger($.Event("vclick",{feedback:!1})),t.lastTouch(!0),u(e.find(".app-listview .dv-item-new .ui-btn"))))),a.focus())}var o=n._pending,c,v,a,s,h,r;if(o&&(v=l.activePage.attr("id"),o.pageId===v))if(a=e(),s=o.action,r=o.direction,c=i.type,h=o.field,s==="cancel"&&c==="pagereadycomplete")y();else if(s==="post"&&c==="dataviewrefresh")y();else return},move:function(o){function ot(){h instanceof jQuery||(h=$(h));t.tooltip(!1);n.sync({dataView:p,elem:h,scrollIntoView:et});tt||(h=null)}var ft,st,ht,p;if(n._moving)return!0;n._moving=!0;typeof o=="string"&&(o={direction:o});var l=o.direction,g=o.originalEvent,ut=g.shiftKey,it=g.ctrlKey,lt=g.metaKey,p=n.dataView(),h=n.fieldElem(p),w,tt,et,b,v,k,nt;switch(l){case"pageup":case"pagedown":return a=e().focus().find('.app-focus[data-input="dataview"]'),a.length&&(n.frame("hide"),t.summary(a).find(".dv-action-see-all .app-btn-"+(l=="pageup"?"prev":"next")+":not(.app-btn-disabled)").trigger($.Event("vclick",{feedback:!1})),n.sync(),w=!0),n._moving=!1,w}if(h){var at=h.closest(".app-listview"),a=at.closest(".app-echo"),d=h.closest(".dv-item").find(".app-field").filter(r),rt;if(et=at.is(".app-grid"),d.each(function(n){if($(this).is(h))return rt=n,!1}),ut)switch(l){case"enter":l="up"}it||l!="enter"||(l="down");tt=a.length>0&&!it;l=="tab"&&(ut?rt==0?s(h,"above")?(h=d[d.length-1],ot(),tt&&(l="up")):tt&&(l="up"):l="left":rt==d.length-1?s(h,"below")?(h=d[0],ot(),tt&&(l="down"),c(p,0)):tt&&(l="down"):l="right");switch(l){case"right":h=d[rt+1];(et||!h)&&(w=!0);break;case"left":h=d[rt-1];h||(w=!0);break;case"home":it||lt?(a.length||t.scrollable(h).scrollTop(0).closest(".ui-page").find(".app-bar-heading").hide(),v=h.closest(".app-listview").find(".dv-item .ui-btn:not(.app-calculated)").first(),v.is(".app-selected")||u(v),g.preventDefault(),h=null):(h=d[0],c(p,0));t.fetchOnDemand();break;case"end":it||lt?(a.length||(ft=t.scrollable(h),ft.length&&ft.scrollTop(ft[0].scrollHeight)),v=h.closest(".app-listview").find(".dv-item .ui-btn:not(.app-calculated)").last(),v.is(".app-selected")||u(v),g.preventDefault(),h=null):h=d[d.length-1];it&&t.fetchOnDemand();break;case"down":case"up":b=l=="down";tt?(v=h.closest(".dv-item"),k=(b?v.next():v.prev()).find(".ui-btn"),!k.length||k.is(".app-calculated,.dv-action-see-all")||k.parent().is(".app-hidden")?(nt=a.find(".dv-action-see-all").filter(r).find(".app-btn-"+(b?"next":"prev")),nt.length&&!nt.is(".app-btn-disabled")?(a.data("auto-highlight",b?"first":"last"),nt.trigger($.Event("vclick",{feedback:!1}))):(n._moving=!1,y(g)!=38&&y(g)!=40&&i.move($("#"+a.data("for")+"_ph"),l))):(u(k),n.scrollIntoView()),h=null,w=!0):h=null;break;case"enter":h.closest(".ui-page").is(".ui-page-active")?(t.lastTouch(!1),n._dataItemSelect=!1,h.trigger("vclick"),n._dataItemSelect=!0,t.lastTouch(!0),w=!0):h=null;break;default:h=null}h&&(ot(),w=!0)}else l!="tab"&&l!="down"&&l!="up"||p||(b=l=="down"||l=="tab"&&!ut,a=t.summary(e().find('.app-focus[data-input="dataview"]')),a.length&&(p=f(a.data("for")),v=a.find(".app-listview .dv-item .app-selected").parent(),st=p.inlineEditing(),(st||!v.length)&&b?(ht=a.find(".dv-item:not(.app-calculated)").first().find(".app-field").filter(r).first(),ht.length&&(y(g)==40||!a.data("skip-item-focus"))?u(ht):i.move($("#"+a.data("for")+"_ph"),ut?"up":"down")):st?i.move($("#"+a.data("for")+"_ph"),"up"):l=="tab"?i.move($("#"+a.data("for")+"_ph"),b?"down":"up"):(k=(b?v.next():v.prev()).find(".ui-btn"),!k.length||k.is(".app-calculated,.dv-action-see-all")||k.parent().is(".app-hidden")?(nt=a.find(".dv-action-see-all").filter(r).find(".app-btn-"+(b?"next":"prev")),nt.length&&!nt.is(".app-btn-disabled")?(a.data("auto-highlight",b?"first":"last"),nt.trigger($.Event("vclick",{feedback:!1}))):i.move($("#"+a.data("for")+"_ph"),b?"down":"up")):(t.makeVisible(k),u(k))),w=!0));if(n._moving=!1,l=="space"&&p&&p.multiSelect()){var ct=n.dataItem().find(".app-btn-check"),vt=ct.closest(".ui-btn"),yt=ct.is(".app-btn-check-selected")&&p._selectedKeyList.length==1;ct.trigger("vclick");yt?n.detach():vt.is(".app-selected")||n.scrollIntoView(vt.closest(".app-listview").find(".ui-btn.app-selected"));w=!0}return w||l!="tab"||$(document.activeElement).closest("[data-input]").length||(p=t.dataView(),i.focus({container:e()})),w},supports:function(n,i){var r=[],u=!1,f=n._viewId;return i=="New"?(r=n.actionGroups("Grid"),r.length&&r[0].Actions.every(function(n){var t=n.CommandArgument;return n.CommandName!=i||t&&t!=f||(u=!0),!u})):(t.contextScope(n._id),t.navContext(r),t.contextScope(null),r.every(function(n){var t=n.argument;return n.command!=i||t&&t!=f||(u=!0),!u})),u},activate:function(){var r,e,nt,p,s,c,w,k,f,l,u,v,tt,d,y;if(!n._pending){if(n._activateInterval=null,t.fetchOnDemand(),r=n.dataView(),c=!1,r&&!n._active&&r.inlineEditing()){if(e=n.fieldElem(r),!e.length)return c;if(nt=h(e),w=r.findFieldUnderAlias(nt),k=r.get_tag(),b(w)||(l=n.supports(r,"Edit"),l?f="Edit":n.supports(r,"New")&&(l=r.rowIsTemplate(r.extension().commandRow()),f="New")),l)n._fieldName=w.Name,n._active=!0,n._elem=e,r._tagList=null,p=e.closest(".dv-item"),p.find(".app-row-status:not(.app-row-status-new)").addClass("app-row-status-edit"),r._tag=(k||"")+" transition-none action-buttons-none content-stub-none page-header-none modal-always modal-title-none modal-tap-out modal-dock-top modal-auto-grow modal-background-transparent modal-max-xs",s=p.find(".ui-btn").data("data-context"),s&&(f!="New"||!r.tagged("optimistic-default-values-none"))&&(u=o.parseJSON(r.session("getPageTemplate")),u&&(v=!0,u.Fields.every(function(n){var t=n.ItemsStyle;return t&&(t.match(/DropDownList|ListBox|RadioButtonList/)&&(n.Items==null||!n.Items.length)||n.ItemsTargetController)&&(v=!1,n.ContextFields&&(tt=!0)),v}),tt||(v?(f=="New"?(u.Rows=[],u.NewRow=s.row,u.Inserting=!0,d=r._controller,r.odp||o.execute({controller:d,view:r._viewId,requiresNewRow:!0,background:!0}).done(function(n){function o(){i.execute({values:u})}var r=n[d][0],u=[],f,e;if(r)for(f in r)e=r[f],e!=null&&u.push({name:f,value:e});u.length&&(t.isInTransition()?t.whenPageShown(o):o())})):u.Rows=[s.row],u.Tag=(u.Tag||"")+r._tag+" view-type-inline-editor",u.SupportsCaching=!1,o.odp.response("GetPage",u)):r._tag+=" system-replacegetpagetemplate"))),f=="New"&&(r._copyExternalLookupValues(),y=r._ditto,y&&y.length&&(n._ditto=y.slice(0))),r._showModal({commandName:f,commandArgument:r.get_viewId()}),r._tagList=null,r._tag=k,c=!0;else{i._buffer=null;var g=r.headerField(),it=r.extension().commandRow(),rt=r.get_view().Label;g&&it&&(headerFieldValue=it[g.Index]);headerFieldValue&&(rt=g.format(headerFieldValue));t.notify(String.format(a.ReadOnly,rt))}}return c}},expandBy:function(i,r){var f=i.closest(".app-page-inlineeditor-overlay"),e,u,s,h,c,o,l=!1,a;return f.length&&(h=t.dataView().session("targetDataView"),c=h.elem.closest(".app-wrapper"),o=c[0].getBoundingClientRect(),e=f.find(".app-wrapper"),scrollableRect=e[0].getBoundingClientRect(),u=Math.min(e.width()+r+3,Math.min(800,o.width*.75)),a=n.frame()[0].getBoundingClientRect(),u=Math.ceil(Math.max(u,a.width)),e.css({minWidth:u,maxWidth:u}),f.css({minWidth:u,maxWidth:u}),s=f[0].getBoundingClientRect(),s.right>o.right&&f.css("left",o.right-s.width-11),l=!0),l},form:function(n){var t=[];return t.push('<div data-layout="form" data-layout-size="xs" class="app-form-inlineeditor"><div data-container="simple" data-wrap="true" data-density="relaxed"><i class="app-icon material-icon material-icon-arrow-back" title="'+k.CancelButton+'">arrow_back<\/i><i class="app-icon material-icon material-icon-more app-btn-more" title="'+a.More+'"/>'),n._fields.forEach(function(n){var i=n.Name;n.Type!="DataView"&&t.push('<div data-container="row" data-visible-when="$app.touch.edit.field(\''+i+'\')"><div class="app-form-inlineeditor-label"><span data-control="label" data-field="'+i+'"><span class="app-control-inner"/><\/span><\/div><span data-control="field" data-field="'+i+'" data-auto-expand="true"><span class="app-control-inner"/><\/span><\/div>')}),t.push("<\/div><\/div>"),t.join("\n")},position:function(i){var w=!d(),b=i.find(".app-wrapper"),ut=b.find(".app-form-inlineeditor"),k=n.field(),ft=ut.find('[data-control="field"][data-field="'+k+'"]'),et=ft.data("input")||"",a=!et.match(/blob|checkboxlist/);if(i.addClass("app-page-inlineeditor").toggleClass("app-custom-density-disabled",w).removeClass("app-page-inlineeditor-overlay"),w){i.data("trackPosition",!1);var g=t.pageInfo(i.attr("id")).dataView,nt=g.session("targetDataView"),f=nt?nt.elem:n._elem,v,o,c,tt,y,r,e,it,rt;if(a&&(rt=g.findField(k),rt.ItemsTargetController&&(a=!1)),a)i.addClass("app-page-inlineeditor-overlay").toggleClass("app-page-inlineeditor-textalignright",f.css("text-align")=="right"),it=f.closest(".app-grid").length>0,it&&i.addClass("app-page-inlineeditor-gridstyle"),v=f.find(".app-field-data"),v.length&&(f=v),o=f[0].getBoundingClientRect(),i.css({maxHeight:"",minHeight:"",height:"",width:"",minWidth:"",maxWidth:""}),r=o.width+2,e=Math.round(o.height),c=Math.round(o.left)-1,tt=Math.round(o.top),y=t.scrollable(f)[0].getBoundingClientRect(),c+r-1>y.right&&(r=y.right-c-9),i.css({left:c,top:tt,maxHeight:e,minHeight:e,height:e,Width:r,minWidth:r,maxWidth:r}),b.css({maxHeight:e,minHeight:e,height:e,width:r,minWidth:r,maxWidth:r});else{if(t.resetPageHeight(i),f){var s=f[0].getBoundingClientRect(),u=i[0].getBoundingClientRect(),h=u.left,l=u.top,p=t.screen();u.height+s.bottom+8<p.height?l=s.bottom+8:s.top-8-u.height>0&&(l=s.top-8-u.height);h=s.left-4;h+u.width-1>p.width&&(h=p.width-4-u.width)}(u.top!=l||u.left!=h)&&i.css({left:h,top:l})}i.data("trackPosition",!0)}else t.resetPageHeight(i)}};$(document).on("dataitemselect.dataview.app",function(i){if(i.namespace=="app.dataview"&&n._dataItemSelect!=!1){var f=t.lastTouch(),o,u,s,e=i.dataView;e.inlineEditing()&&(f&&(o=$(document.elementFromPoint(f.x,f.y)),u=o.closest(".app-field"),u.length||e.extension().viewStyle()!="Grid"||o.find(".app-field").filter(r).each(function(){var t=this,n=t.getBoundingClientRect();if(f.x<n.left||n.left<=f.x&&f.x<=n.right)return u=$(t),!1}),u.length||(s=o.closest(".dv-item"),s.length&&(fieldName=(e.session("dataEditor")||{}).fieldName,fieldName&&(u=s.find(".app-field-"+fieldName))),u.length||(u=s.find(".app-field").first())),u.length||(u=null)),n.sync({dataView:e,elem:u,scrollIntoView:!0,ignoreOtherInputs:!0}),i.action=="select"&&e.extension()._autoSelect&&setTimeout(t.executeInContext),i.preventDefault())}}).on("resizing.app",function(t){t.namespace=="app"&&n.detach()}).on("clear.dataview.app",function(){n.detach()}).on("keyboardnavigation.app",function(t){var i=t.originalEvent;if(t.namespace=="app"&&!n._active)if(t.direction=="edit"){if(n.activate())return!1}else if(n.move({direction:t.direction,originalEvent:i}))return!1}).on("keyboardpreview.app",function(t){if(n.frame(":active")){var r=t.originalEvent,u=r.key||"";u.length!=1&&!u.match(/Backspace|Del|Delete/)||r.ctrlKey||r.altKey||r.metaKey||(i._buffer=u,r.preventDefault(),setTimeout(n.activate))}}).on("showcontextmenu.app",function(i){function s(n){t.lastTouch(!1);n.trigger("vclick");t.lastTouch(!0);c=!1}var u=n.fieldElem(),f=i.originalEvent,o,c,h;return u?(o=u.closest(".app-echo"),f.shiftKey&&o.length?s(o.find(".app-echo-toolbar .app-btn-more")):f.ctrlKey&&s(u.closest(".dv-item").find(".app-btn-more"))):f.ctrlKey&&(h=e()[0].getBoundingClientRect(),l.activePage.find(".app-listview .app-selected .app-btn-more").filter(r).each(function(){var n=this.getBoundingClientRect();if(n.top>h.top&&n.top<h.bottom)return s($(this)),!1})),c}).on("mousedown",".app-focus-frame",function(){t.clearHtmlSelection()}).on("vclick",".app-focus-frame",function(i){t.pointer("touch")&&i.type=="vclick"?n.activate():w=setTimeout(function(){e().focus()},200)}).on("contextmenu taphold",".app-focus-frame",function(){n.frame().hide();var i=t.lastTouch(),r=document.elementFromPoint(i.x,i.y);n.frame().show();$(r).trigger("contextmenu")}).on("dblclick",".app-focus-frame",function(){clearTimeout(w);t.pointer("mouse")&&n.activate()}).on("generatelayout.dataview.app",function(t){t.dataView._inlineEditor&&(t.layout=n.form(t.dataView))}).on("pagepositionchanged.app",function(t){n.position(t.page)}).on("pagereadycomplete.app",function(t){var i=n.instance(),c=n._elem,u,r,e,o,s,h;if(i)if(n.position(t.page),n._active=!0,t.reverse)v(i);else if(c){if(s=f(i._parentDataViewId),i._inlineFields=g(s),i.session("targetDataView",{id:s._id,elem:c}),n._elem=null,i.inserting()&&!i._newRowBroadcasted){i._newRowBroadcasted=!0;u=i.data();r=[];for(e in u)o=u[e],o!=null&&r.push({name:e,value:o});r.length&&(n._broadcastValues(i,r),n.position(t.page))}}else v(i);else n._active=!1;h=n._lastSyncOptions;h&&(n._lastSyncOptions=null,n.sync(h));n.commit(t)}).on("dataviewrefresh.app",function(i){n.commit(i);var r=i.dataView,u=r.session("inlineEditor");u!=null&&(r.gridChanged(),t.stickyHeaderBar().hide(),t.stickyHeader(),r.session("inlineEditor",null),u&&n.activate())}).on("datainputbroadcast.app",function(t){var i=t.dataView;i._inlineEditor&&n._broadcastValues(i,t.values)}).on("datainputmove.app",function(u){var o,e,f,s,h,c;if(n.frame(":visible")&&(o=t.dataView(),o&&o._inlineEditor)){if(f=u.direction,f&&typeof f!="string"){if(f.closest(".app-focus-frame").length)return setTimeout(function(){i.focus({lastFocused:!0})}),!1;if(e=f.closest(".app-field"),e.length||(h=t.lastTouch(),h&&f.closest(".app-grid").length?f.closest(".dv-item").find(".app-field").filter(r).each(function(){var n=this.getBoundingClientRect();if(h.x<n.left||n.left<=h.x&&h.x<=n.right)return e=$(this),!1}):f.closest(".app-listview").length||(s=(f.attr("class")||"").match(/\bapp\-field\-(\w+)\b/),s&&s[1]!=n.field()&&(e=o.session("targetDataView").elem.closest(".dv-item").find("."+s[0]),e.length&&n.field(s[1])))),e.length){if(u.direction=e,c=o.session("targetDataView"),!e.closest(".app-listview").is(c.elem.closest(".app-listview")))return}else return}u.fromDataInput||(u.fromDataInput=t.pageInfo().scrollable.find('[data-input][data-field="'+n.field()+'"]'));n.moveInput(u)}}).on("dataviewignorechanges.app",function(t){var i=t.dataView;i._inlineEditor&&n.undo(i)}).on("inlineeditingmode.dataview.app",function(i){var r=i.dataView,f=r.extension(),l=f.commandRow(),o=i.inlineEditing,s,h,c,a;o?(s=e(),h=t.pageInfo(),c=h&&h.dataView==r?s.find(".app-listview .dv-item .ui-btn").first():s.find('.app-echo[ data-for="'+r._id+'"] .app-listview .dv-item .ui-btn').first(),t.lastTouch(!1),l?f.tap(l,"highlight"):u(c),t.lastTouch(!0),f.viewStyle().match(/(Grid|List|Cards)/)&&(r.inlineEditing()||r.inlineEditing(o,!i.editor),a=n.frame(),n.sync({dataView:r,elem:c.find("app-field-"+r._fields[0].Name)}),t.makeVisible(a),r.session("inlineEditor",i.editor))):(r.inlineEditing(o),n.detach());t.scrollGrid(r,!0);r.sync()}).on("vclick",'.app-form-inlineeditor [data-container="simple"] .material-icon',function(n){var t=$(n.target);return t.is(".material-icon-arrow-back")?history.go(-1):$(document).trigger($.Event("keydown",{keyCode:121,shiftKey:!0})),!1})})();